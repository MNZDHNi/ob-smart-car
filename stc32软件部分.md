### 核心模块驱动开发

这是软件部分的重中之重，需要逐个击破。

1. **电磁信号采集与处理**
    
    - **ADC 驱动**：
        
        - 配置多通道ADC，以循环扫描模式采集多个电感（通常6个或更多）的电压值。
            
        - 理解ADC的采样率、精度（12位）和稳定性。
            
    - **数字滤波算法**：
        
        - **软件防脉冲干扰平均滤波**：简单有效，抵抗突发噪声。
            
        - **一阶互补滤波/低通滤波**：平滑数据，减少高频抖动。
            
    - **赛道信息提取**：
        
        - **归一化**：由于电感值会受电池电压、环境等影响，需要将ADC值归一化到固定范围（如0-1000）。
            
        - **偏差计算**：这是控制的核心。常用方法有：
            
            - **差比和**：`偏差 = (左电感值 - 右电感值) / (左电感值 + 右电感值)`。这是最经典的方法，能消除信号强度的影响。
                
            - **绝对值差**：`偏差 = 左电感值 - 右电感值`。
                
            - **十字路口、环岛等元素的识别**：通过分析多个电感的数值变化模式（例如，中间电感值突降，两边电感值升高）来识别特殊赛道元素。
                
2. **电机控制**
    
    - **PWM 驱动**：
        
        - 配置高级PWM定时器（如PWMA, PWMB）产生两路PWM分别控制左、右电机。
            
        - 理解PWM的频率和占空比。频率一般在10kHz-20kHz之间。
            
    - **电机驱动方向控制**：
        
        - 使用GPIO控制电机驱动芯片（如TB6612, DRV8833）的AIN1/AIN2, BIN1/BIN2，实现正转、反转和刹车。
            
    - **PID 控制算法**：
        
        - **速度PID**：让车保持恒定或按策略变化的速度。编码器提供反馈。
            
        - **方向PID/舵机PID**：根据计算出的“偏差”，控制舵机（或使用差速控制时的电机差速）进行转向。
            
3. **传感器（编码器）处理**
    
    - **编码器计数**：
        
        - 配置定时器的**正交编码器接口模式**，自动对电机编码器的脉冲进行计数。这是获取电机真实转速最准确的方式。
            
    - **速度计算**：
        
        - 在固定周期（如10ms）内读取编码器计数值，换算成实际速度。
            

### 核心控制算法集成

将各个模块组合起来，形成完整的控制系统。

1. **控制系统框架**
    
    - **定时中断服务程序**：
        
        - 建立一个稳定的时间基准，例如1ms或5ms中断一次。
            
        - 在中断中执行**按键扫描**、**标志位更新**等。
            
    - **主循环**：
        
        - 采用“前台-后台”系统。后台（主循环）执行主要任务，前台（中断）处理紧急事务。
            
    - **任务调度**：
        
        - 可以设计一个简单的**时间片轮询**调度器，让不同任务（如：图像处理、控制算法、数据显示）在指定时间有序执行。
            
2. **核心PID算法实现与调参**
    
    - **位置式PID vs 增量式PID**：智能车常用增量式，因为它输出的是增量，不会积分饱和，更安全。
        
    - **PID组合策略**：
        
        - **串联PID**：方向环PID的输出作为速度环的期望速度差值。`左轮速度 = 期望速度 - PID(方向偏差)`， `右轮速度 = 期望速度 + PID(方向偏差)`。这是最常用的方法。
            
        - **单PID**：直接用一个PID的输出控制舵机打角，电机只负责恒速。结构简单，但性能有限。
            
    - **调参技巧**：先P，后D，最后I。在赛道上动态调试，观察车的响应。
        

### 高级策略与优化

1. **赛道元素处理**
    
    - 编写状态机来识别和处理**十字路口、环岛、坡道、起跑线**等。
        
    - 例如，进入环岛时，需要切换一套不同的PID参数和控制逻辑。
        
2. **运动控制算法**
    
    - **差速控制模型**：理解小车运动学，如何通过左右轮速差来实现转向。
        
    - **路径优化**：例如“内切入弯”，通过在直道末端提前转向，以更高的整体速度过弯。
        
3. **调试与数据分析**
    
    - **OLED/LCD显示屏**：实时显示关键数据，如电感值、偏差、速度、PID参数等。
        
    - **蓝牙串口**：将数据（如电感波形、速度曲线）发送到上位机（如匿名科创地面站、SerialChart）进行可视化分析。**这是调车的利器！**
        
    - **按键与菜单**：方便地在车上修改PID参数、运行模式等，而无需重新烧录程序。
        

### 工程实践

1. **代码架构**
    
    - 模块化编程，将ADC、Motor、Encoder、PID等写成独立的 `.c` 和 `.h` 文件。
        
    - 使用 `config.h` 头文件集中管理所有可调参数（PID参数、速度、滤波系数等）。
        
2. **系统稳定性**
    
    - **看门狗**：配置独立看门狗，防止程序跑飞。
        
    - **电源管理**：监测电池电压，防止低电压导致单片机复位或控制异常。
        
    - **异常处理**：对传感器数据的合理性进行判断，并做相应处理。
        

### 学习路径建议

1. **从点灯开始**：控制一个LED闪烁，熟悉开发环境。
    
2. **驱动单个外设**：先让电机转起来，再读取一个电感的值并在OLED上显示。
    
3. **组合模块**：读取两个电感，计算偏差，并用P控制让舵机随偏差转动。
    
4. **引入速度闭环**：加上编码器，实现电机的速度PID控制。
    
5. **实现完整控制**：将方向环和速度环串联起来，让车能慢速循迹。
    
6. **优化与提速**：加入D控制抑制震荡，优化路径，处理特殊元素，逐步提高车速。
    

总结来说，STC32G12K128电磁组智能车的软件学习是一个从底层驱动到上层算法的系统工程。重点在于 **ADC采集滤波**、**偏差计算** 和 **PID控制** 这三驾马车。同时，**熟练的调试手段**是让你从“车能动”到“车飞快”的关键。祝你成功！