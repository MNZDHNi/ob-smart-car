# 一、DMA的优势

1. **提高系统效率**：CPU可以同时执行其他任务
2. **高速数据传输**：适合大数据量传输
3. **降低功耗**：CPU可以进入低功耗模式
4. **实时性更好**：避免因CPU繁忙导致数据丢失

# 二、STC32G12K128的DMA特性

## DMA控制器特性

|特性|描述|
|---|---|
|**DMA通道数**|多个独立通道|
|**传输方向**|内存↔外设，内存↔内存|
|**数据宽度**|8位、16位、32位|
|**地址模式**|固定地址、递增地址|
|**触发方式**|软件触发、硬件触发|
|**中断支持**|传输完成中断、半传输中断|

## 支持DMA的外设

- **ADC**：自动传输转换结果
- **SPI**：高速数据收发
- **UART**：大量数据通信
- **I2C**：批量数据传输
- **PWM**：波形数据加载
- **自定义外设**：通用DMA传输

# 三、DMA相关寄存器详解

## 1. DMA通用控制寄存器

### DMA控制状态寄存器（DMA_CSR）

|位|功能|描述|
|---|---|---|
|7|DMA_EN|DMA控制器总使能|
|6|-|保留|
|5|CIRCULAR|循环模式使能|
|4|HALF_IE|半传输中断使能|
|3|FULL_IE|传输完成中断使能|
|2|ERR_IE|错误中断使能|
|1|TRANSFER|传输状态标志|
|0|CH_EN|通道使能|

## 2. 通道配置寄存器

### DMA通道配置寄存器（DMA_CCR）

```c
// 通道配置位定义
typedef struct {
    uint8_t EN:1;           // 通道使能
    uint8_t DIR:1;          // 传输方向 (0:外设→内存, 1:内存→外设)
    uint8_t CIRCULAR:1;     // 循环模式
    uint8_t PINC:1;         // 外设地址递增
    uint8_t MINC:1;         // 内存地址递增
    uint8_t PSIZE:2;        // 外设数据宽度 (00:8位, 01:16位, 10:32位)
    uint8_t MSIZE:2;        // 内存数据宽度
    uint8_t PL:2;           // 通道优先级
    uint8_t MEM2MEM:1;      // 内存到内存模式
} DMA_CCR_Bits;
```

## 3. 地址和数量寄存器

每个DMA通道都有以下寄存器：

- **DMA_CPARx**：外设地址寄存器
- **DMA_CMARx**：内存地址寄存器
- **DMA_CNDTRx**：传输数据数量寄存器

# 四、DMA工作模式

## 1. 传输模式

### 正常模式

```c
// 传输指定数量的数据后停止
DMA_CNDTRx = 1000;  // 传输1000个数据后停止
```

### 循环模式

```c
// 传输完成后自动重新开始，适合连续数据流
DMA_CCR |= (1 << CIRCULAR_BIT);
```

## 2. 数据传输方向

```c
// 外设到内存（如ADC采集数据到数组）
DMA_CCR &= ~(1 << DIR_BIT);

// 内存到外设（如数组数据发送到UART）
DMA_CCR |= (1 << DIR_BIT);

// 内存到内存（数据块拷贝）
DMA_CCR |= (1 << MEM2MEM_BIT);
```

## 3. 地址增量模式

```c
// 外设地址固定（如ADC数据寄存器）
DMA_CCR &= ~(1 << PINC_BIT);

// 外设地址递增（如内存到内存传输）
DMA_CCR |= (1 << PINC_BIT);

// 内存地址递增（通常使能）
DMA_CCR |= (1 << MINC_BIT);
```
